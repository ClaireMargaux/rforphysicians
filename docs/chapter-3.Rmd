---
title: "Chapter 3"
author: "Claire Descombes"
date: "`r Sys.Date()`"
contact: claire.descombes@insel.ch
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    df_print: paged
    theme: paper
    code_folding: show
    math_method: katex
subtitle: "R for physicians"
bibliography: /home/claire/Documents/GitHub/rforphysicians/docs/Rforphysicians.bib
link-citations: yes
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {rmarkdown::render(input)})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE,
  message = FALSE, 
  fig.height = 5,
  fig.width = 6,
  eval = TRUE
)
library(ggplot2)
```

| Author           |                                                                 |
|:-----------------|:----------------------------------------------------------------|
| Name             | Claire Descombes                                                |
| Affiliation      | UniversitÃ¤tsklinik fÃ¼r Neurochirurgie, Inselspital Bern         |
| Degree           | MSc Statistics and Data Science, University of Bern             |
| Contact          | [claire.descombes@insel.ch](mailto:claire.descombes@insel.ch)   |

The reference material for this course, as well as some useful literature to deepen your knowledge of R, can be found at the bottom of the page.

***************

The base R plotting functions are effective and user-friendly, so we will begin by exploring their features.

Next, we will take a look at the functions offered by `ggplot2`, a system for declarative graphics creation. You provide the data and specify how to map variables to aesthetics and which graphical primitives to use; ggplot2 then takes care of the details. Although it is slightly more technical than base R, it produces very aesthetically pleasing results.

TTo explore Râ€™s plotting capabilities, weâ€™ll continue working with the NHANES datasets. Specifically, weâ€™ll use the merged data frame that combines the `demo`, `bpx`, `bmx` and `smq` data sets. If you still have it loaded from Chapter 2, you can use it directly. Otherwise, you can download it from the [`data_sets` folder](https://github.com/ClaireMargaux/rforphysicians/tree/main/data_sets) and import it into R.

```{r, echo=TRUE}
# Load the merged_nhanes CSV file
merged_nhanes <- read.csv("/home/claire/Documents/GitHub/rforphysicians/data_sets/merged_nhanes.csv")
```

# Including plots using base R

## Scatter plots

```{r, out.width="75%"}
plot(x = merged_nhanes$RIDAGEYR, y = merged_nhanes$BPXSY1,
     xlab = "Age of participant [years]",
     ylab = "Systolic blood pressure (1st reading) [mmHg]",
     main = "Scatterplot of age vs. systolic BP",
     col = c("steelblue"))
```

ðŸ’¡ The arguments `xlab` and `ylab` allow fyou to define a label for the x and y axes respectively. The argument `main` defines the main title of the plot.

## Box plots

```{r, out.width="75%"}
boxplot(merged_nhanes$BPXSY1 ~ merged_nhanes$RIAGENDR,
        names = c("Male", "Female"),
        xlab = "Gender",
        ylab = "Systolic blood pressure (1st reading) [mmHg]",
        main = "Boxplot of BP by gender",
        col = c("salmon", "skyblue"))
```

## Bar plots

```{r, out.width="75%"}
# We define the age groups in which to calculate the mean systolic blood pressure
age_groups <- cut(x = merged_nhanes$RIDAGEYR, breaks = seq(10, 80, 10))
head(age_groups)

# We calculate the mean systolic blood pressure by age group
(avg_bp <- tapply(X = merged_nhanes$BPXSY1, INDEX = age_groups, FUN = mean, na.rm = TRUE))

barplot(avg_bp,
        xlab = "Age group [years]",
        ylab = "Average systolic BP [mmHg]",
        main = "Bar plot of average systolic BP by age group",
        col = "steelblue")
```

ðŸ’¡ `cut()` divides the range of the imputed vector into intervals and codes its values according to which interval they fall. The leftmost interval corresponds to level one, the next leftmost to level two and so on.

ðŸ’¡  `tapply()` applies some function to an object, grouped by a list of factors. It uses the following basic syntax: `tapply(X, INDEX, FUN, ..)`, where: X = object to apply a function to, INDEX = vector of factors to group by, FUN = function to apply. It returns a multi-way array containing the values.

## Histograms

```{r, out.width="75%"}
hist(merged_nhanes$BMXBMI,
     breaks = 30,
     freq = TRUE,
     col = "steelblue",
     xlab = "Body Mass Index (BMI)",
     main = "Histogram of BMI")
```

ðŸ’¡ The argument `breaks` is a vector giving the breakpoints between histogram cells or a function to compute the vector of breakpoints.
ðŸ’¡ The argument `freq` is a logical: if TRUE, the histogram graphic is a representation of frequencies, the counts component of the result; if FALSE, probability densities, component density, are plotted.

## Line plots

```{r, out.width="75%"}
# We define the age groups in which to calculate the mean systolic blood pressure
age_groups <- cut(x = merged_nhanes$RIDAGEYR, breaks = seq(10, 80, 10))
head(age_groups)

# We calculate the mean systolic blood pressure by age group
(avg_bp <- tapply(X = merged_nhanes$BPXSY1, INDEX = age_groups, FUN = mean, na.rm = TRUE))

# We define the midpoints of the intervals
midpoints <- seq(15, 75, 10)

plot(midpoints, avg_bp, type = "b",
     xlab = "Age (midpoint of group) [years]",
     ylab = "Mean systolic BP [mmHg]",
     main = "Mean systolic BP by age group",
     col = "steelblue")
```

ðŸ’¡ The argument `type` is 1-character string giving the type of plot desired. The following values are possible:

  + "p" for *points*
  + "l" for *lines*
  + "b" for *both points and lines*
  + "c" for empty points joined by lines
  + "o" for overplotted points and lines
  + "s" and "S" for stair steps and "h" for histogram-like vertical lines

## Pie charts

```{r, out.width="75%"}
(gender_table <- table(merged_nhanes$RIAGENDR))
pie(x = gender_table,
    labels = c("Female", "Male"),
    col = c("skyblue", "salmon"),
    main = "Gender Distribution")
```

ðŸ’¡ `table()` uses cross-classifying factors to build a contingency table of the counts at each combination of factor levels.

Personally, I would recommend *avoiding* pie charts, as the human eye is not very good at recognising angle ratios. I favour bar plots, for example.

## Mosaic plots

```{r, out.width="75%"}
(smoking_gender_table <- table(merged_nhanes$RIAGENDR, merged_nhanes$SMQ020))
mosaicplot(smoking_gender_table[,c("Yes","No")], # we select only the 'yes/no' answers
           main = "Mosaic plot of smoking status by gender",
           xlab = "Gender",
           ylab = "Smoked at least 100 cigarettes?",
           col = c("steelblue"))
```

## Forest plots

Base R does not include a built-in function for forest plots, but you can use a package like `forestplot` for that, or `ggplot2` (see below).

```{r, out.width="75%"}
library(forestplot)

# Calculate summary statistics by gender
genders <- unique(merged_nhanes$RIAGENDR)
means <- numeric(length(genders))
sds <- numeric(length(genders))
ns <- numeric(length(genders))
lowers <- numeric(length(genders))
uppers <- numeric(length(genders))
gender_labels <- character(length(genders))

# Loop over gender groups to compute stats
for (i in seq_along(genders)) {
  group_data <- merged_nhanes$BPXSY1[merged_nhanes$RIAGENDR == genders[i]]
  group_data <- group_data[!is.na(group_data)]
  means[i] <- mean(group_data)
  sds[i] <- sd(group_data)
  ns[i] <- length(group_data)
  lowers[i] <- means[i] - 1.96 * sds[i] / sqrt(ns[i])
  uppers[i] <- means[i] + 1.96 * sds[i] / sqrt(ns[i])
  gender_labels[i] <- genders[i]
}

# Create the forest plot
forestplot(labeltext = c("Male","Female"),
           mean = means,
           lower = lowers,
           upper = uppers,
           zero = 120,
           grid = TRUE,
           ci.vertices = TRUE,
           xlab = "Systolic BP (95% CI) [mmHg]",
           col = fpColors(box = "steelblue", line = "steelblue"),
           title = "Forest plot of systolic BP by gender")
```

# Including plots using `ggplot2`

```{r, echo=TRUE, eval=FALSE}
# Start by installing ggplot2
install.packages("ggplot2")
library(ggplot2) # after installation

# Note that the ggplot2 package is included in some R package collections, e.g. the tidyverse collection, which is specifically designed for data science and also contains other useful packages like dplyr.
install.packages("tidyverse")
library(tidyverse) # after installation
```

`ggplot2` is based on the grammar of graphics â€” the idea that every graph can be built from the same basic components:

* a *data set*, 
* a *coordinate system*, and
* *geoms*: visual marks (like points, lines, bars) that represent data.
 
Structure of a `ggplot2` graph:

```{r ggplot2-structure, echo=FALSE, out.width="75%"}
knitr::include_graphics(path = "images/ggplot2-structure.png")
```

How to build a plot:

  1. Start with `ggplot()`, where you provide the dataset (and optionally the aesthetic mapping).
  2. Add layers, such as:

  + `geom_point()` (scatter plot)
  + `geom_histogram()` (histogram)
  + `geom_line()` (line plot)
  + `scales` (e.g., scale_y_log10())
  + `faceting` (e.g., facet_wrap())
  + `coordinate systems` (e.g., coord_flip())

  3. Define aesthetics using `aes()`: these describe how variables in the data are mapped to visual properties like: x, y, color, fill, linetype, size, etc.

ðŸ’¡ You can place `aes()` either in `ggplot()` (to apply it *globally*) or inside the individual `geom_*()` functions (to apply it *locally*).

The geom function must be chosen according to the type of data examined (two continuous variables, one categorical and one continuous variable, etc.).

## Scatter plots

```{r, out.width="75%"}
ggplot(merged_nhanes, aes(x = RIDAGEYR, y = BPXSY1)) +
  geom_point(alpha = 0.5, col = "steelblue") +
  labs(title = "Scatterplot of age vs. systolic BP",
       x = "Age of participant [years]",
       y = "Systolic blood pressure (1st reading) [mmHg]") +
  theme_minimal()
```

Or equivalently:

```{r, out.width="75%"}
ggplot(merged_nhanes) +
  geom_point(aes(x = RIDAGEYR, y = BPXSY1), alpha = 0.5, col = "steelblue") +
  labs(title = "Scatterplot of age vs. systolic BP",
       x = "Age of participant [years]",
       y = "Systolic blood pressure (1st reading) [mmHg]") +
  theme_minimal()
```

## Box plots

```{r, out.width="75%"}
ggplot(data = merged_nhanes, aes(x = factor(RIAGENDR, labels = c("Male", "Female")), y = BPXSY1, fill = factor(RIAGENDR))) +
  geom_boxplot() +
  scale_fill_manual(values = c("salmon", "skyblue")) +
  labs(title = "Box plot of systolic BP by gender",
       x = "Gender",
       y = "Systolic BP (1st reading) [mmHg]") +
  theme_minimal() +
  theme(legend.position = "none")
```

## Bar plots 

```{r, out.width="75%"}
# We define the age groups in which to calculate the mean systolic blood pressure
age_groups <- cut(x = merged_nhanes$RIDAGEYR, breaks = seq(10, 80, 10))
head(age_groups)

# We calculate the mean systolic blood pressure by age group
(avg_bp <- aggregate(BPXSY1 ~ age_groups, data = merged_nhanes, FUN = function(x) mean(x, na.rm = TRUE)))

ggplot(avg_bp, aes(x = age_groups, y = BPXSY1)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Bar plot of mean systolic BP by age group",
       x = "Age group [years]",
       y = "Mean systolic BP [mmHg]") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

ðŸ’¡ `aggregate()` splits the data into subsets, computes summary statistics for each, and returns the result as a data frame.

## Histograms

```{r, out.width="75%"}
ggplot(merged_nhanes, aes(x = BMXBMI)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  labs(title = "Histogram of BMI",
       x = "Body Mass Index (BMI)",
       y = "Count") +
  theme_minimal()
```

ðŸ’¡ A quick reminder that the number of bins in a histogram is extremely important and should be given careful consideration, as the appearance of the data can vary significantly depending on this choice, which could potentially be misleading.

An example with the age of the household reference person:

```{r, out.width="75%"}
ggplot(merged_nhanes, aes(x = DMDHRAGE)) +
  geom_histogram(bins = 40, fill = "steelblue", color = "white") +
  labs(title = "Histogram of age of the household reference person (40 bins)",
       x = "Age [years]",
       y = "Count") +
  theme_minimal()

ggplot(merged_nhanes, aes(x = DMDHRAGE)) +
  geom_histogram(bins = 20, fill = "steelblue", color = "white") +
  labs(title = "Histogram of age of the household reference person (20 bins)",
       x = "Age [years]",
       y = "Count") +
  theme_minimal()

ggplot(merged_nhanes, aes(x = DMDHRAGE)) +
  geom_histogram(bins = 10, fill = "steelblue", color = "white") +
  labs(title = "Histogram of age of the household reference person (10 bins)",
       x = "Age [years]",
       y = "Count") +
  theme_minimal()
```

## Line plots

```{r, out.width="75%"}
avg_bp$midpoint <- seq(15, 75, 10)  # midpoint of intervals

ggplot(avg_bp, aes(x = midpoint, y = BPXSY1)) +
  geom_line(col = "steelblue") +
  geom_point(col = "steelblue") +
  labs(title = "Mean systolic BP by age group",
       x = "Age (midpoint of group) [years]",
       y = "Mean systolic BP [mmHg]") +
  theme_minimal()
```

## Pie charts

```{r, out.width="75%"}
# Count gender
gender_counts <- as.data.frame(table(merged_nhanes$RIAGENDR))
colnames(gender_counts) <- c("Gender", "n")

# Compute proportions
gender_counts$prop <- gender_counts$n / sum(gender_counts$n)

# Compute y positions for labels (center of each slice)
gender_counts$ypos <- cumsum(gender_counts$prop) - 0.5 * gender_counts$prop

# Resulting data frame
gender_counts

ggplot(gender_counts, aes(x = "", y = prop, fill = Gender)) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(y = ypos, label = scales::percent(prop)), color = "white") +
  scale_fill_manual(values = c("salmon", "skyblue")) +
  labs(title = "Pie chart of gender distribution") +
  theme_void()
```

## Mosaic plots

`ggplot2` does not include a built-in function for mosaic plots, but can be extended with the `ggmoisaic` package for that.

```{r, out.width="75%"}
library(ggmosaic)

ggplot(data = merged_nhanes[merged_nhanes$SMQ020 %in% c("Yes","No"),]) +
  geom_mosaic(aes(x = product(RIAGENDR), fill = SMQ020)) +
  scale_fill_manual(values = c("salmon", "skyblue")) +
  labs(x = "Gender", y = "Smoked at least 100 cigarettes?", title = "Mosaic plot of smoking status by gender") +
  theme_minimal() +
  theme(legend.position = "none")
```

## Forest plots

```{r, out.width="75%"}
# Calculate summary statistics by gender
genders <- unique(merged_nhanes$RIAGENDR)
means <- numeric(length(genders))
sds <- numeric(length(genders))
ns <- numeric(length(genders))
lowers <- numeric(length(genders))
uppers <- numeric(length(genders))

# Loop over gender groups to compute stats
for (i in seq_along(genders)) {
  group_data <- merged_nhanes$BPXSY1[merged_nhanes$Gender == genders[i]]
  means[i] <- mean(group_data)
  sds[i] <- sd(group_data)
  ns[i] <- length(group_data)
  lowers[i] <- means[i] - 1.96 * sds[i] / sqrt(ns[i])
  uppers[i] <- means[i] + 1.96 * sds[i] / sqrt(ns[i])
}

# Create result data frame
(forest_df <- data.frame(
  Gender = genders,
  mean = means,
  sd = sds,
  n = ns,
  lower = lowers,
  upper = uppers
))

ggplot(forest_df, aes(x = mean, y = Gender)) +
  geom_point(size = 3, color = "steelblue") +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, color = "steelblue") +
  geom_vline(xintercept = 120, linetype = "dashed") +
  labs(title = "Forest plot of systolic BP by gender",
       x = "Systolic BP (95% CI) [mmHg]",
       y = "") +
  theme_minimal()
```

# Solutions to the exercises

# NHANES data sets

Here are listed some of the variables from the NHANES data sets.

## Demographics (DEMO_G)

| Variable Name | Description                                           |
| ------------- | ----------------------------------------------------- |
| RIDAGEYR      | Participant's age in years                            |
| RIAGENDR      | Participant's gender                                  |
| DMDHHSIZ      | Total number of people in the household               |
| DMDHHSZA      | Number of children aged 5 or younger in the household |
| DMDHRAGE      | Age of the household reference person                 |
| DMDHRMAR      | Marital status of the household reference person      |
| DMDHRGND      | Gender of the household reference person              |
| AIALANGA      | Language of the interview                             |

## Blood Pressure (BPX_G)

| Variable Name | Description                                        |
| ------------- | -------------------------------------------------- |
| BPXSY1        | Systolic blood pressure (first reading) in mm Hg   |
| BPXSY2        | Systolic blood pressure (second reading) in mm Hg  |
| BPXSY3        | Systolic blood pressure (third reading) in mm Hg   |
| BPXDI1        | Diastolic blood pressure (first reading) in mm Hg  |
| BPXDI2        | Diastolic blood pressure (second reading) in mm Hg |
| BPXDI3        | Diastolic blood pressure (third reading) in mm Hg  |
| BPXPULS       | Pulse rate (beats per minute)                      |
| BPXPLS        | 60-second pulse (30-second pulse multiplied by 2)  |
| BPXPTY        | Pulse type (e.g., regular or irregular)            |
| BPXML1        | Maximum inflation level (mm Hg)                    |

## Body Measures (BMX_G)

| Variable Name | Description                  |
| ------------- | ---------------------------- |
| BMXWT         | Weight (kg)                  |
| BMXHT         | Standing height (cm)         |
| BMXBMI        | Body Mass Index (kg/mÂ²)      |
| BMXWAIST      | Waist circumference (cm)     |
| BMXHIP        | Hip circumference (cm)       |
| BMXARML       | Upper arm length (cm)        |
| BMXARMC       | Upper arm circumference (cm) |
| BMXLEG        | Upper leg length (cm)        |

## Smoking Questionnaire (SMQ_G)

| Variable Name | Description                                 |
| ------------- | ------------------------------------------- |
| SMQ020        | Smoked at least 100 cigarettes in life      |
| SMQ040        | Do you now smoke cigarettes?                |
| SMQ050Q       | Average number of cigarettes smoked per day |
| SMD030        | Age when first smoked cigarettes regularly  |
| SMD070        | Age when last smoked cigarettes regularly   |
| SMQ680        | Smoked cigars in the past 5 days            |
| SMQ690        | Smoked pipes in the past 5 days             |
| SMQ700        | Smoked chewing tobacco in the past 5 days   |
| SMQ710        | Smoked snuff in the past 5 days             |

# References

---
nocite: '@*'
...