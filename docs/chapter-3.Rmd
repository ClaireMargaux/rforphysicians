---
title: "Chapter 3"
author: "Claire Descombes"
date: "`r Sys.Date()`"
contact: claire.descombes@insel.ch
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    df_print: paged
    theme: paper
    code_folding: show
    math_method: katex
subtitle: "R for physicians"
bibliography: /home/claire/Documents/GitHub/rforphysicians/docs/Rforphysicians.bib
link-citations: yes
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {rmarkdown::render(input)})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE,
  message = FALSE, 
  fig.height = 5,
  fig.width = 6,
  eval = TRUE
)
library(ggplot2)
```

| Author           |                                                                 |
|:-----------------|:----------------------------------------------------------------|
| Name             | Claire Descombes                                                |
| Affiliation      | Universitätsklinik für Neurochirurgie, Inselspital Bern         |
| Degree           | MSc Statistics and Data Science, University of Bern             |
| Contact          | [claire.descombes@insel.ch](mailto:claire.descombes@insel.ch)   |

The reference material for this course, as well as some useful literature to deepen your knowledge of R, can be found at the bottom of the page.

***************

The base R plotting functions are effective and user-friendly, so we will begin by exploring their features.

Next, we will take a look at the functions offered by `ggplot2`, a system for declarative graphics creation. You provide the data and specify how to map variables to aesthetics and which graphical primitives to use; ggplot2 then takes care of the details. Although it is slightly more technical than base R, it produces very aesthetically pleasing results.

TTo explore R’s plotting capabilities, we’ll continue working with the NHANES datasets. Specifically, we’ll use the merged data frame that combines the `demo`, `bpx`, `bmx` and `smq` data sets. If you still have it loaded from Chapter 2, you can use it directly. Otherwise, you can download it from the [`data_sets` folder](https://github.com/ClaireMargaux/rforphysicians/tree/main/data_sets) and import it into R.

```{r, echo=TRUE}
# Load the merged_nhanes CSV file
merged_nhanes <- read.csv("/home/claire/Documents/GitHub/rforphysicians/data_sets/merged_nhanes.csv")
```

# Including plots using base R

## Scatter plots

```{r, out.width="75%"}
plot(x = merged_nhanes$RIDAGEYR, y = merged_nhanes$BPXSY1,
     xlab = "Age of participant",
     ylab = "Systolic blood pressure (1st reading)",
     main = "Scatterplot of Age vs. Systolic BP")
```

## Box plots

```{r, out.width="75%"}
boxplot(merged_nhanes$BPXSY1 ~ merged_nhanes$RIAGENDR,
        names = c("Male", "Female"),
        xlab = "Gender",
        ylab = "Systolic blood pressure (1st reading)",
        main = "Blood Pressure by Gender",
        col = c("salmon", "skyblue"))
```

## Bar plots

```{r, out.width="75%"}
age_groups <- cut(merged_nhanes$RIDAGEYR, breaks = seq(10, 80, 10))
avg_bp <- tapply(merged_nhanes$BPXSY1, age_groups, mean, na.rm = TRUE)
barplot(avg_bp,
        xlab = "Age group",
        ylab = "Average Systolic BP",
        main = "Average Systolic BP by Age Group",
        col = "steelblue")
```

## Histograms

```{r, out.width="75%"}
hist(merged_nhanes$BMXBMI,
     breaks = 30,
     col = "steelblue",
     xlab = "Body Mass Index (BMI)",
     main = "Histogram of BMI")
```

## Line plots

```{r, out.width="75%"}
age_groups <- cut(merged_nhanes$RIDAGEYR, breaks = seq(0, 80, 10))
avg_bp <- tapply(merged_nhanes$BPXSY1, age_groups, mean, na.rm = TRUE)

# Extract midpoints of the intervals
midpoints <- seq(5, 75, 10)

plot(midpoints, avg_bp, type = "b",
     xlab = "Age (midpoint of group)",
     ylab = "Average Systolic BP",
     main = "Average Systolic BP by Age Group")
```

## Pie charts

```{r, out.width="75%"}
pie(table(merged_nhanes$RIAGENDR),
    labels = c("Male", "Female"),
    col = c("salmon", "skyblue"),
    main = "Gender Distribution")
```

## Mosaic plots

```{r, out.width="75%"}
mosaicplot(table(merged_nhanes$RIAGENDR, merged_nhanes$SMQ020)[,c("Yes","No")],
           main = "Smoking Status by Gender",
           xlab = "Gender",
           ylab = "Smoked at least 100 cigarettes?",
           col = c("steelblue"))
```

## Forest plots

Base R does not include a built-in function for forest plots, but you can use the `forestplot` package for that.

```{r, out.width="75%"}
library(forestplot)

# Calculate summary statistics by gender
genders <- unique(merged_nhanes$RIAGENDR)
means <- numeric(length(genders))
sds <- numeric(length(genders))
ns <- numeric(length(genders))
lowers <- numeric(length(genders))
uppers <- numeric(length(genders))
gender_labels <- character(length(genders))

for (i in seq_along(genders)) {
  group_data <- merged_nhanes$BPXSY1[merged_nhanes$RIAGENDR == genders[i]]
  group_data <- group_data[!is.na(group_data)]
  means[i] <- mean(group_data)
  sds[i] <- sd(group_data)
  ns[i] <- length(group_data)
  lowers[i] <- means[i] - 1.96 * sds[i] / sqrt(ns[i])
  uppers[i] <- means[i] + 1.96 * sds[i] / sqrt(ns[i])
  gender_labels[i] <- genders
}

# Prepare the table text for the forest plot
tabletext <- cbind(
  c("Gender", gender_labels),
  c("Mean systolic BP", sprintf("%.1f", means))
)[-1, ]

# Create the forest plot
forestplot(labeltext = tabletext,
           mean = means,
           lower = lowers,
           upper = uppers,
           zero = 120,
           xlog = FALSE,
           boxsize = 0.2,
           col = fpColors(box = "steelblue", line = "steelblue"),
           title = "Systolic Blood Pressure by Gender")
```

# Including plots using `ggplot2`

```{r, echo=TRUE, eval=FALSE}
# Start by installing ggplot2
install.packages("ggplot2")
library(ggplot2) # after installation

# Note that the ggplot2 package is included in some R package collections, e.g. the tidyverse collection, which is specifically designed for data science.
install.packages("tidyverse")
library(tidyverse) # after installation
```

`ggplot2` is based on the grammar of graphics, the idea that you can build every graph from the same components: 

* a data set, 
* a coordinate system, 
* and geoms—visual marks that represent data points.
 
To display values, map variables in the data to visual properties of the geom (aesthetics) like size, color, and x and y locations.

```{r ggplot2-structure, echo=FALSE, out.width="50%"}
knitr::include_graphics(path = "images/ggplot2-structure.png")
```

Absolutely unavoidable are the 

* data: our data set
* geom function: geom_point(), geom_line(), geom_histogram(), geom_bar(), geom_qq(), etc.
* and mappings: color, filling, linetype, linewidth, etc.

The geom function must be chosen according to the type of data examined (two continuous variables, one categorical and one continuous variable, etc.).

## Scatter plots

```{r, out.width="75%"}
ggplot(merged_nhanes, aes(x = RIDAGEYR, y = BPXSY1)) +
  geom_point(alpha = 0.5) +
  labs(title = "Scatterplot of Age vs. Systolic BP",
       x = "Age of participant",
       y = "Systolic blood pressure (1st reading)") +
  theme_minimal()
```

## Box plots

```{r, out.width="75%"}
ggplot(merged_nhanes, aes(x = factor(RIAGENDR, labels = c("Male", "Female")), y = BPXSY1, fill = factor(RIAGENDR))) +
  geom_boxplot() +
  scale_fill_manual(values = c("salmon", "skyblue")) +
  labs(title = "Blood Pressure by Gender",
       x = "Gender",
       y = "Systolic blood pressure (1st reading)") +
  theme_minimal() +
  theme(legend.position = "none")
```

## Bar plots 

```{r, out.width="75%"}
# Create age groups
merged_nhanes$age_group <- cut(merged_nhanes$RIDAGEYR, breaks = seq(10, 80, 10))

# Compute the mean systolic BP per age group using aggregate
avg_bp <- aggregate(BPXSY1 ~ age_group, data = merged_nhanes, FUN = function(x) mean(x, na.rm = TRUE))

ggplot(avg_bp, aes(x = age_group, y = BPXSY1)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Average Systolic BP by Age Group",
       x = "Age group",
       y = "Average Systolic BP") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Histograms

```{r, out.width="75%"}
ggplot(merged_nhanes, aes(x = BMXBMI)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  labs(title = "Histogram of BMI",
       x = "Body Mass Index (BMI)",
       y = "Count") +
  theme_minimal()
```

## Line plots

```{r, out.width="75%"}
avg_bp$midpoint <- seq(15, 75, 10)  # midpoint of intervals

ggplot(avg_bp, aes(x = midpoint, y = BPXSY1)) +
  geom_line() +
  geom_point() +
  labs(title = "Average Systolic BP by Age Group",
       x = "Age (midpoint of group)",
       y = "Average Systolic BP") +
  theme_minimal()
```

## Pie charts

```{r, out.width="75%"}
# Remove NAs from RIAGENDR
gender_data <- merged_nhanes[!is.na(merged_nhanes$RIAGENDR), ]

# Count gender
gender_counts_table <- table(gender_data$RIAGENDR)

# Convert to data frame
gender_counts <- as.data.frame(gender_counts_table)
colnames(gender_counts) <- c("RIAGENDR", "n")

# Assign gender labels
gender_counts$Gender <- gender_counts$RIAGENDR

# Compute proportions
gender_counts$prop <- gender_counts$n / sum(gender_counts$n)

# Compute y positions for labels (center of each slice)
gender_counts$ypos <- cumsum(gender_counts$prop) - 0.5 * gender_counts$prop

ggplot(gender_counts, aes(x = "", y = prop, fill = Gender)) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(y = ypos, label = scales::percent(prop)), color = "white") +
  scale_fill_manual(values = c("salmon", "skyblue")) +
  labs(title = "Gender Distribution") +
  theme_void()
```

## Mosaic plots

`ggplot2` does not include a built-in function for mosaic plots, but you can use the `vcd` package for that.

```{r, out.width="75%"}
library(vcd)

# Keep only rows where SMQ020 is 1 (Yes) or 2 (No) and RIAGENDR is 1 or 2
valid_idx <- merged_nhanes$SMQ020 %in% c("Yes", "No") & merged_nhanes$RIAGENDR %in% c("Male", "Female")
valid_data <- merged_nhanes[valid_idx, ]

# Create labeled contingency table
smoke_gender_table <- table(
  Gender = factor(valid_data$RIAGENDR, labels = c("Male", "Female")),
  Smoked_100_cigs = factor(valid_data$SMQ020, labels = c("Yes", "No"))
)

# Plot mosaic
mosaic(smoke_gender_table, shade = TRUE, legend = TRUE,
       main = "Smoking Status by Gender")
```

## Forest plots

```{r, out.width="75%"}
# Remove rows with missing gender or BP
clean_data <- merged_nhanes[!is.na(merged_nhanes$RIAGENDR) & !is.na(merged_nhanes$BPXSY1), ]

# Assign factor labels for gender
clean_data$Gender <- factor(clean_data$RIAGENDR, labels = c("Male", "Female"))

# Get unique gender levels
genders <- levels(clean_data$Gender)

# Initialize vectors
means <- numeric(length(genders))
sds <- numeric(length(genders))
ns <- numeric(length(genders))
lowers <- numeric(length(genders))
uppers <- numeric(length(genders))

# Loop over gender groups to compute stats
for (i in seq_along(genders)) {
  group_data <- clean_data$BPXSY1[clean_data$Gender == genders[i]]
  means[i] <- mean(group_data)
  sds[i] <- sd(group_data)
  ns[i] <- length(group_data)
  lowers[i] <- means[i] - 1.96 * sds[i] / sqrt(ns[i])
  uppers[i] <- means[i] + 1.96 * sds[i] / sqrt(ns[i])
}

# Create result data frame
forest_df <- data.frame(
  Gender = genders,
  mean = means,
  sd = sds,
  n = ns,
  lower = lowers,
  upper = uppers
)

ggplot(forest_df, aes(x = mean, y = Gender)) +
  geom_point(size = 3, color = "steelblue") +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, color = "steelblue") +
  geom_vline(xintercept = 120, linetype = "dashed") +
  labs(title = "Systolic Blood Pressure by Gender",
       x = "Mean Systolic BP (95% CI)",
       y = "") +
  theme_minimal()
```

# Solutions to the exercises

# NHANES data sets

Here are listed some of the variables from the NHANES data sets.

## Demographics (DEMO_G)

| Variable Name | Description                                           |
| ------------- | ----------------------------------------------------- |
| RIDAGEYR      | Participant's age in years                            |
| RIAGENDR      | Participant's gender                                  |
| DMDHHSIZ      | Total number of people in the household               |
| DMDHHSZA      | Number of children aged 5 or younger in the household |
| DMDHRAGE      | Age of the household reference person                 |
| DMDHRMAR      | Marital status of the household reference person      |
| DMDHRGND      | Gender of the household reference person              |
| AIALANGA      | Language of the interview                             |

## Blood Pressure (BPX_G)

| Variable Name | Description                                        |
| ------------- | -------------------------------------------------- |
| BPXSY1        | Systolic blood pressure (first reading) in mm Hg   |
| BPXSY2        | Systolic blood pressure (second reading) in mm Hg  |
| BPXSY3        | Systolic blood pressure (third reading) in mm Hg   |
| BPXDI1        | Diastolic blood pressure (first reading) in mm Hg  |
| BPXDI2        | Diastolic blood pressure (second reading) in mm Hg |
| BPXDI3        | Diastolic blood pressure (third reading) in mm Hg  |
| BPXPULS       | Pulse rate (beats per minute)                      |
| BPXPLS        | 60-second pulse (30-second pulse multiplied by 2)  |
| BPXPTY        | Pulse type (e.g., regular or irregular)            |
| BPXML1        | Maximum inflation level (mm Hg)                    |

## Body Measures (BMX_G)

| Variable Name | Description                  |
| ------------- | ---------------------------- |
| BMXWT         | Weight (kg)                  |
| BMXHT         | Standing height (cm)         |
| BMXBMI        | Body Mass Index (kg/m²)      |
| BMXWAIST      | Waist circumference (cm)     |
| BMXHIP        | Hip circumference (cm)       |
| BMXARML       | Upper arm length (cm)        |
| BMXARMC       | Upper arm circumference (cm) |
| BMXLEG        | Upper leg length (cm)        |

## Smoking Questionnaire (SMQ_G)

| Variable Name | Description                                 |
| ------------- | ------------------------------------------- |
| SMQ020        | Smoked at least 100 cigarettes in life      |
| SMQ040        | Do you now smoke cigarettes?                |
| SMQ050Q       | Average number of cigarettes smoked per day |
| SMD030        | Age when first smoked cigarettes regularly  |
| SMD070        | Age when last smoked cigarettes regularly   |
| SMQ680        | Smoked cigars in the past 5 days            |
| SMQ690        | Smoked pipes in the past 5 days             |
| SMQ700        | Smoked chewing tobacco in the past 5 days   |
| SMQ710        | Smoked snuff in the past 5 days             |

# References

---
nocite: '@*'
...